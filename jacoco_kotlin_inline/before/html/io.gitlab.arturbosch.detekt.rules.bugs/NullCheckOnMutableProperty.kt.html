<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NullCheckOnMutableProperty.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">code-coverage-report</a> &gt; <a href="index.source.html" class="el_package">io.gitlab.arturbosch.detekt.rules.bugs</a> &gt; <span class="el_source">NullCheckOnMutableProperty.kt</span></div><h1>NullCheckOnMutableProperty.kt</h1><pre class="source lang-java linenums">package io.gitlab.arturbosch.detekt.rules.bugs

import io.gitlab.arturbosch.detekt.api.CodeSmell
import io.gitlab.arturbosch.detekt.api.Config
import io.gitlab.arturbosch.detekt.api.DetektVisitor
import io.gitlab.arturbosch.detekt.api.Entity
import io.gitlab.arturbosch.detekt.api.RequiresTypeResolution
import io.gitlab.arturbosch.detekt.api.Rule
import io.gitlab.arturbosch.detekt.rules.isNonNullCheck
import io.gitlab.arturbosch.detekt.rules.isNullCheck
import org.jetbrains.kotlin.name.FqName
import org.jetbrains.kotlin.psi.KtBinaryExpression
import org.jetbrains.kotlin.psi.KtConstantExpression
import org.jetbrains.kotlin.psi.KtFile
import org.jetbrains.kotlin.psi.KtIfExpression
import org.jetbrains.kotlin.psi.KtNameReferenceExpression
import org.jetbrains.kotlin.psi.KtPrimaryConstructor
import org.jetbrains.kotlin.psi.KtProperty
import org.jetbrains.kotlin.psi.KtReferenceExpression
import org.jetbrains.kotlin.resolve.calls.util.getResolvedCall
import org.jetbrains.kotlin.resolve.descriptorUtil.fqNameOrNull

/**
 * Reports null-checks on mutable properties, as these properties' value can be
 * changed - and thus make the null-check invalid - after the execution of the
 * if-statement.
 *
 * &lt;noncompliant&gt;
 * class A(private var a: Int?) {
 *   fun foo() {
 *     if (a != null) {
 *       println(2 + a!!)
 *     }
 *   }
 * }
 * &lt;/noncompliant&gt;
 *
 * &lt;compliant&gt;
 * class A(private val a: Int?) {
 *   fun foo() {
 *     if (a != null) {
 *       println(2 + a)
 *     }
 *   }
 * }
 * &lt;/compliant&gt;
 */
@RequiresTypeResolution
<span class="fc" id="L49">class NullCheckOnMutableProperty(config: Config) : Rule(</span>
<span class="fc" id="L50">    config,</span>
<span class="fc" id="L51">    &quot;Checking nullability on a mutable property is not useful because the property may be set to null afterwards.&quot;</span>
) {

    override fun visitKtFile(file: KtFile) {
<span class="fc" id="L55">        super.visitKtFile(file)</span>
<span class="fc" id="L56">        NullCheckVisitor().visitKtFile(file)</span>
<span class="fc" id="L57">    }</span>

<span class="fc" id="L59">    private inner class NullCheckVisitor : DetektVisitor() {</span>
<span class="fc" id="L60">        private val mutableProperties = mutableSetOf&lt;FqName&gt;()</span>
<span class="fc" id="L61">        private val candidateProperties = mutableMapOf&lt;FqName, MutableList&lt;KtIfExpression&gt;&gt;()</span>

        override fun visitPrimaryConstructor(constructor: KtPrimaryConstructor) {
<span class="fc" id="L64">            super.visitPrimaryConstructor(constructor)</span>
<span class="fc" id="L65">            constructor.valueParameters.asSequence()</span>
<span class="fc" id="L66">                .filter { it.isMutable }</span>
<span class="fc" id="L67">                .mapNotNull { it.fqName }</span>
<span class="fc" id="L68">                .forEach(mutableProperties::add)</span>
<span class="fc" id="L69">        }</span>

        override fun visitProperty(property: KtProperty) {
<span class="fc" id="L72">            super.visitProperty(property)</span>
<span class="fc" id="L73">            val fqName = property.fqName</span>
<span class="fc bfc" id="L74" title="All 6 branches covered.">            if (fqName != null &amp;&amp; (property.isVar || property.getter != null)) {</span>
<span class="fc" id="L75">                mutableProperties.add(fqName)</span>
            }
<span class="fc" id="L77">        }</span>

        override fun visitIfExpression(expression: KtIfExpression) {
            // Extract all possible null-checks within the if-expression.
<span class="pc bpc" id="L81" title="1 of 2 branches missed.">            val nonNullChecks = (expression.condition as? KtBinaryExpression)</span>
<span class="pc bpc" id="L82" title="1 of 2 branches missed.">                ?.collectNonNullChecks()</span>
<span class="pc bpc" id="L83" title="1 of 2 branches missed.">                .orEmpty()</span>

<span class="fc" id="L85">            val modifiedCandidateQueues = nonNullChecks.mapNotNull { nonNullCondition -&gt;</span>
<span class="fc bfc" id="L86" title="All 2 branches covered.">                if (nonNullCondition.left is KtConstantExpression) {</span>
<span class="pc bpc" id="L87" title="1 of 2 branches missed.">                    nonNullCondition.right as? KtNameReferenceExpression</span>
                } else {
<span class="fc bfc" id="L89" title="All 2 branches covered.">                    nonNullCondition.left as? KtNameReferenceExpression</span>
<span class="fc bfc" id="L90" title="All 2 branches covered.">                }?.getResolvedCall(bindingContext)</span>
<span class="fc bfc" id="L91" title="All 2 branches covered.">                    ?.resultingDescriptor</span>
<span class="pc bpc" id="L92" title="1 of 2 branches missed.">                    ?.fqNameOrNull()</span>
<span class="pc bpc" id="L93" title="1 of 4 branches missed.">                    ?.takeIf(mutableProperties::contains)</span>
<span class="fc bfc" id="L94" title="All 2 branches covered.">                    ?.let { candidateFqName -&gt;</span>
                        // A candidate mutable property is present, so attach the current
                        // if-expression to it in the property candidates map.
<span class="fc" id="L97">                        candidateProperties.getOrPut(candidateFqName) { ArrayDeque() }</span>
<span class="fc" id="L98">                            .apply { add(expression) }</span>
<span class="fc" id="L99">                    }</span>
            }
            // Visit descendant expressions to see whether candidate properties
            // identified in this if-expression are being referenced.
<span class="fc" id="L103">            super.visitIfExpression(expression)</span>
            // Remove the if-expression after having iterated out of its code block.
<span class="fc" id="L105">            modifiedCandidateQueues.forEach { it.removeLast() }</span>
<span class="fc" id="L106">        }</span>

        override fun visitReferenceExpression(expression: KtReferenceExpression) {
<span class="fc" id="L109">            super.visitReferenceExpression(expression)</span>
<span class="fc" id="L110">            expression.getResolvedCall(bindingContext)</span>
<span class="fc bfc" id="L111" title="All 2 branches covered.">                ?.resultingDescriptor</span>
<span class="pc bpc" id="L112" title="1 of 2 branches missed.">                ?.fqNameOrNull()</span>
<span class="fc bfc" id="L113" title="All 2 branches covered.">                ?.let { fqName -&gt;</span>
<span class="fc" id="L114">                    val expressionParent = expression.parent</span>
                    // Don't check the reference expression if it's being invoked in the if-expression
                    // where it's being null-checked.
                    if (
<span class="fc bfc" id="L118" title="All 2 branches covered.">                        expressionParent !is KtBinaryExpression ||</span>
<span class="fc bfc" id="L119" title="All 4 branches covered.">                        (!expressionParent.isNonNullCheck() &amp;&amp; !expressionParent.isNullCheck())</span>
                    ) {
                        // If there's an if-expression attached to the candidate property, a null-checked
                        // mutable property is being referenced.
<span class="pc bpc" id="L123" title="1 of 4 branches missed.">                        candidateProperties[fqName]?.lastOrNull()?.let { ifExpression -&gt;</span>
<span class="fc" id="L124">                            report(</span>
<span class="fc" id="L125">                                CodeSmell(</span>
<span class="fc" id="L126">                                    Entity.from(ifExpression),</span>
<span class="fc" id="L127">                                    &quot;Null-check is being called on mutable property '$fqName'.&quot;</span>
                                )
                            )
<span class="fc" id="L130">                        }</span>
                    }
<span class="fc" id="L132">                }</span>
<span class="fc" id="L133">        }</span>

        private fun KtBinaryExpression.collectNonNullChecks(): List&lt;KtBinaryExpression&gt; =
<span class="fc bfc" id="L136" title="All 2 branches covered.">            if (isNonNullCheck()) {</span>
<span class="fc" id="L137">                listOf(this)</span>
            } else {
<span class="fc" id="L139">                val nonNullChecks = mutableListOf&lt;KtBinaryExpression&gt;()</span>
<span class="fc bfc" id="L140" title="All 4 branches covered.">                (left as? KtBinaryExpression)?.let { nonNullChecks.addAll(it.collectNonNullChecks()) }</span>
<span class="fc bfc" id="L141" title="All 4 branches covered.">                (right as? KtBinaryExpression)?.let { nonNullChecks.addAll(it.collectNonNullChecks()) }</span>
<span class="fc" id="L142">                nonNullChecks</span>
<span class="fc" id="L143">            }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202408290909</span></div></body></html>