<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>KDocReferencesNonPublicProperty.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">code-coverage-report</a> &gt; <a href="index.source.html" class="el_package">io.gitlab.arturbosch.detekt.rules.documentation</a> &gt; <span class="el_source">KDocReferencesNonPublicProperty.kt</span></div><h1>KDocReferencesNonPublicProperty.kt</h1><pre class="source lang-java linenums">package io.gitlab.arturbosch.detekt.rules.documentation

import io.gitlab.arturbosch.detekt.api.CodeSmell
import io.gitlab.arturbosch.detekt.api.Config
import io.gitlab.arturbosch.detekt.api.DetektVisitor
import io.gitlab.arturbosch.detekt.api.Entity
import io.gitlab.arturbosch.detekt.api.Rule
import org.jetbrains.kotlin.psi.KtClass
import org.jetbrains.kotlin.psi.KtDeclaration
import org.jetbrains.kotlin.psi.KtNamedDeclaration
import org.jetbrains.kotlin.psi.KtObjectDeclaration
import org.jetbrains.kotlin.psi.KtParameter
import org.jetbrains.kotlin.psi.KtProperty
import org.jetbrains.kotlin.psi.psiUtil.containingClassOrObject
import org.jetbrains.kotlin.psi.psiUtil.getTopmostParentOfType
import org.jetbrains.kotlin.psi.psiUtil.isProtected
import org.jetbrains.kotlin.psi.psiUtil.isPublic

/**
 * This rule will report any KDoc comments that refer to non-public properties of a class.
 * Clients do not need to know the implementation details.
 *
 * &lt;noncompliant&gt;
 * /**
 *  * Comment
 *  * [prop1] - non-public property
 *  * [prop2] - public property
 *  */
 * class Test {
 *     private val prop1 = 0
 *     val prop2 = 0
 * }
 * &lt;/noncompliant&gt;
 *
 * &lt;compliant&gt;
 * /**
 *  * Comment
 *  * [prop2] - public property
 *  */
 * class Test {
 *     private val prop1 = 0
 *     val prop2 = 0
 * }
 * &lt;/compliant&gt;
 *
 */
<span class="fc" id="L47">class KDocReferencesNonPublicProperty(config: Config) : Rule(</span>
<span class="fc" id="L48">    config,</span>
<span class="fc" id="L49">    &quot;KDoc comments should not refer to non-public properties.&quot;</span>
) {

<span class="fc" id="L52">    private val publicPropertiesByClass = mutableMapOf&lt;KtClass, MutableSet&lt;KtNamedDeclaration&gt;&gt;()</span>
<span class="fc" id="L53">    private val privatePropertiesByClass = mutableMapOf&lt;KtClass, MutableSet&lt;KtNamedDeclaration&gt;&gt;()</span>

    override fun visitClass(klass: KtClass) {
<span class="fc" id="L56">        super.visitClass(klass)</span>

<span class="pc bpc" id="L58" title="1 of 4 branches missed.">        val comment = klass.docComment?.text ?: return</span>

<span class="fc bfc" id="L60" title="All 2 branches covered.">        klass.primaryConstructor?.accept(</span>
<span class="fc" id="L61">            object : DetektVisitor() {</span>
                override fun visitParameter(parameter: KtParameter) {
<span class="fc" id="L63">                    super.visitParameter(parameter)</span>
<span class="fc" id="L64">                    klass.registerProperty(parameter)</span>
<span class="fc" id="L65">                }</span>
            }
        )

<span class="fc" id="L69">        val privateProperties = privatePropertiesByClass.remove(klass)</span>
<span class="fc" id="L70">        val publicPropertyNames = publicPropertiesByClass.remove(klass)</span>
<span class="pc bpc" id="L71" title="1 of 2 branches missed.">            ?.mapTo(mutableSetOf()) { it.qualifiedName() }</span>
<span class="pc bpc" id="L72" title="1 of 2 branches missed.">            .orEmpty()</span>

<span class="fc bfc" id="L74" title="All 4 branches covered.">        for (privateProperty in privateProperties.orEmpty()) {</span>
<span class="fc" id="L75">            val qualifiedName = privateProperty.qualifiedName()</span>
<span class="fc" id="L76">            val matchesPublicProperty = publicPropertyNames.contains(qualifiedName)</span>
<span class="fc bfc" id="L77" title="All 4 branches covered.">            if (!matchesPublicProperty &amp;&amp; comment.contains(&quot;[$qualifiedName]&quot;)) {</span>
<span class="fc" id="L78">                report(privateProperty)</span>
            }
        }
<span class="fc" id="L81">    }</span>

    override fun visitNamedDeclaration(declaration: KtNamedDeclaration) {
<span class="fc" id="L84">        super.visitNamedDeclaration(declaration)</span>
<span class="fc bfc" id="L85" title="All 2 branches covered.">        declaration.getTopmostParentOfType&lt;KtClass&gt;()?.registerProperty(declaration)</span>
<span class="fc" id="L86">    }</span>

    private fun KtClass.registerProperty(declaration: KtNamedDeclaration) {
<span class="fc bfc" id="L89" title="All 2 branches covered.">        if (declaration.isNonPublicInherited()) {</span>
            // only consider property declarations (not constructor parameters) as private properties which cannot be
            // referenced in kdoc
<span class="fc bfc" id="L92" title="All 2 branches covered.">            if (declaration is KtProperty) {</span>
<span class="fc" id="L93">                privatePropertiesByClass.getOrPut(this) { mutableSetOf() }.add(declaration)</span>
            }
        } else {
<span class="fc" id="L96">            publicPropertiesByClass.getOrPut(this) { mutableSetOf() }.add(declaration)</span>
        }
<span class="fc" id="L98">    }</span>

    private fun KtDeclaration.isNonPublicInherited(): Boolean {
<span class="fc bfc" id="L101" title="All 4 branches covered.">        if (!isPublic &amp;&amp; !isProtected()) {</span>
<span class="fc" id="L102">            return true</span>
        }
<span class="fc" id="L104">        var classOrObject = containingClassOrObject</span>
<span class="fc bfc" id="L105" title="All 2 branches covered.">        while (classOrObject is KtObjectDeclaration) {</span>
<span class="fc bfc" id="L106" title="All 2 branches covered.">            if (!classOrObject.isPublic) {</span>
<span class="fc" id="L107">                return true</span>
            }
<span class="fc" id="L109">            classOrObject = classOrObject.containingClassOrObject</span>
        }
<span class="fc" id="L111">        return false</span>
    }

    private fun KtNamedDeclaration.qualifiedName(): String {
<span class="fc" id="L115">        var qualifiedName = nameAsSafeName.asString()</span>
<span class="fc" id="L116">        var classOrObject = containingClassOrObject</span>
<span class="fc bfc" id="L117" title="All 2 branches covered.">        while (classOrObject is KtObjectDeclaration) {</span>
<span class="fc" id="L118">            qualifiedName = &quot;${classOrObject.nameAsSafeName.asString()}.$qualifiedName&quot;</span>
<span class="fc" id="L119">            classOrObject = classOrObject.containingClassOrObject</span>
        }
<span class="fc" id="L121">        return qualifiedName</span>
    }

    private fun report(property: KtNamedDeclaration) {
<span class="fc" id="L125">        report(</span>
<span class="fc" id="L126">            CodeSmell(</span>
<span class="fc" id="L127">                Entity.atName(property),</span>
<span class="fc" id="L128">                &quot;The property ${property.nameAsSafeName} &quot; +</span>
                    &quot;is non-public and should not be referenced from KDoc comments.&quot;
            )
        )
<span class="fc" id="L132">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202408290909</span></div></body></html>