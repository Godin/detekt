<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LicenceHeaderLoaderExtension.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">code-coverage-report</a> &gt; <a href="index.source.html" class="el_package">io.gitlab.arturbosch.detekt.rules.documentation</a> &gt; <span class="el_source">LicenceHeaderLoaderExtension.kt</span></div><h1>LicenceHeaderLoaderExtension.kt</h1><pre class="source lang-java linenums">package io.gitlab.arturbosch.detekt.rules.documentation

import io.gitlab.arturbosch.detekt.api.Config
import io.gitlab.arturbosch.detekt.api.FileProcessListener
import io.gitlab.arturbosch.detekt.api.SetupContext
import io.gitlab.arturbosch.detekt.rules.documentation.AbsentOrWrongFileLicense.Companion.DEFAULT_LICENSE_TEMPLATE_FILE
import io.gitlab.arturbosch.detekt.rules.documentation.AbsentOrWrongFileLicense.Companion.DEFAULT_LICENSE_TEMPLATE_IS_REGEX
import io.gitlab.arturbosch.detekt.rules.documentation.AbsentOrWrongFileLicense.Companion.PARAM_LICENSE_TEMPLATE_FILE
import io.gitlab.arturbosch.detekt.rules.documentation.AbsentOrWrongFileLicense.Companion.PARAM_LICENSE_TEMPLATE_IS_REGEX
import io.gitlab.arturbosch.detekt.rules.documentation.AbsentOrWrongFileLicense.Companion.RULE_NAME
import org.jetbrains.kotlin.com.intellij.openapi.util.Key
import org.jetbrains.kotlin.com.intellij.openapi.util.text.StringUtilRt
import org.jetbrains.kotlin.psi.KtFile
import java.nio.file.Path
import kotlin.io.path.absolute
import kotlin.io.path.exists
import kotlin.io.path.readText
import kotlin.io.path.toPath

<span class="fc" id="L20">class LicenceHeaderLoaderExtension : FileProcessListener {</span>

    private lateinit var config: Config
    private var configPath: Path? = null

<span class="fc" id="L25">    override val id: String = &quot;LicenceHeaderLoaderExtension&quot;</span>

    override fun init(context: SetupContext) {
<span class="fc" id="L28">        this.config = context.config</span>
<span class="fc bfc" id="L29" title="All 2 branches covered.">        this.configPath = context.configUris.lastOrNull()?.toPath()</span>
<span class="fc" id="L30">    }</span>

    override fun onStart(files: List&lt;KtFile&gt;) {
<span class="fc" id="L33">        fun Config.isActive() = this.valueOrDefault(Config.ACTIVE_KEY, false)</span>

        fun shouldRuleRun(): Boolean {
<span class="fc" id="L36">            val comments = config.subConfig(&quot;comments&quot;)</span>
<span class="fc" id="L37">            val ruleConfig = comments.subConfig(RULE_NAME)</span>
<span class="pc bpc" id="L38" title="1 of 4 branches missed.">            return comments.isActive() &amp;&amp; ruleConfig.isActive()</span>
        }

<span class="fc" id="L41">        fun getPathToTemplate(): String = config.subConfig(&quot;comments&quot;)</span>
<span class="fc" id="L42">            .subConfig(RULE_NAME)</span>
<span class="fc" id="L43">            .valueOrDefault(PARAM_LICENSE_TEMPLATE_FILE, DEFAULT_LICENSE_TEMPLATE_FILE)</span>

<span class="fc" id="L45">        fun isRegexTemplate(): Boolean = config.subConfig(&quot;comments&quot;)</span>
<span class="fc" id="L46">            .subConfig(RULE_NAME)</span>
<span class="fc" id="L47">            .valueOrDefault(PARAM_LICENSE_TEMPLATE_IS_REGEX, DEFAULT_LICENSE_TEMPLATE_IS_REGEX)</span>

        fun loadLicence(dir: Path): String {
<span class="fc" id="L50">            val templateFile = dir.resolve(getPathToTemplate())</span>

<span class="pc bpc" id="L52" title="1 of 2 branches missed.">            require(templateFile.exists()) {</span>
<span class="nc" id="L53">                &quot;&quot;&quot;</span>
<span class="nc" id="L54">                    Rule '$RULE_NAME': License template file not found at `${templateFile.absolute()}`.</span>
                    Create file license header file or check your running path.
<span class="nc" id="L56">                &quot;&quot;&quot;.trimIndent()</span>
            }

<span class="fc" id="L59">            return templateFile.readText().convertLineSeparators()</span>
        }

        fun cacheLicence(dir: Path, isRegexTemplate: Boolean) {
<span class="fc" id="L63">            val licenceHeader = loadLicence(dir)</span>
<span class="fc bfc" id="L64" title="All 2 branches covered.">            if (!isRegexTemplate) {</span>
<span class="fc bfc" id="L65" title="All 2 branches covered.">                for (file in files) {</span>
<span class="fc" id="L66">                    file.putUserData(LICENCE_KEY, licenceHeader)</span>
                }
<span class="fc" id="L68">                return</span>
            }
<span class="fc" id="L70">            val licenseHeaderRegex = licenceHeader.toRegex(RegexOption.MULTILINE)</span>
<span class="fc bfc" id="L71" title="All 2 branches covered.">            for (file in files) {</span>
<span class="fc" id="L72">                file.putUserData(LICENCE_REGEX_KEY, licenseHeaderRegex)</span>
            }
<span class="fc" id="L74">        }</span>

<span class="fc bfc" id="L76" title="All 4 branches covered.">        if (configPath != null &amp;&amp; shouldRuleRun()) {</span>
<span class="pc bpc" id="L77" title="2 of 4 branches missed.">            val configDir = configPath?.parent ?: return</span>
<span class="fc" id="L78">            cacheLicence(configDir, isRegexTemplate())</span>
        }
<span class="fc" id="L80">    }</span>
}

<span class="fc" id="L83">private fun String.convertLineSeparators() = StringUtilRt.convertLineSeparators(this)</span>

<span class="fc" id="L85">internal val LICENCE_KEY = Key.create&lt;String&gt;(&quot;LICENCE_HEADER&quot;)</span>
<span class="fc" id="L86">internal val LICENCE_REGEX_KEY = Key.create&lt;Regex&gt;(&quot;LICENCE_HEADER_REGEX&quot;)</span>

<span class="fc bfc" id="L88" title="All 2 branches covered.">internal fun KtFile.hasLicenseHeader(): Boolean = this.getUserData(LICENCE_KEY) != null</span>

<span class="pc bpc" id="L90" title="1 of 2 branches missed.">internal fun KtFile.getLicenseHeader(): String = this.getUserData(LICENCE_KEY) ?: error(&quot;License header expected&quot;)</span>

<span class="fc bfc" id="L92" title="All 2 branches covered.">internal fun KtFile.hasLicenseHeaderRegex(): Boolean = this.getUserData(LICENCE_REGEX_KEY) != null</span>

internal fun KtFile.getLicenseHeaderRegex(): Regex =
<span class="pc bpc" id="L95" title="1 of 2 branches missed.">    this.getUserData(LICENCE_REGEX_KEY) ?: error(&quot;License header regex expected&quot;)</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202408290909</span></div></body></html>